<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>Crop Recommendation | AgriSmart</title>
    <link rel="stylesheet" href="{% static 'assets/css/styles.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    body { background: #f6faf6;}
    .crop-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 1.1rem 2rem 0.7rem 2rem;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 2px 12px rgba(80,110,50,0.08);
        margin-bottom: 18px;
    }
    .back-btn { background: none; border: none; font-size: 1.4rem; color: #24411f; cursor: pointer;}
    .crop-header-title { font-size: 1.15rem; font-weight: bold; color: #24411f; }
    .crop-section-title { font-size: 2.5rem; text-align: center; font-weight: 700; margin-top: 36px; color: #193718;}
    .crop-section-subtitle { color: #5a715a; text-align: center; font-size: 1.2rem; margin-bottom: 32px;}
    .form-card {
        background: #fff; border-radius: 16px;
        padding: 35px 30px 24px 30px;
        box-shadow: 0 2px 16px rgba(80,110,50,0.12);
        width: 82%; margin: 0 auto 32px auto;
    }
    .form-title {
        font-size: 1.7rem; font-weight: 600;
        color: #193718; margin-bottom: 18px;
    }
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 18px;
    }
    .form-row input, .form-row select {
        width: 100%;
        padding: 13px 16px;
        font-size: 1.13rem;
        border: 2px solid #bfdabc;
        border-radius: 8px;
        background: #f8fbf8;
        color: #224a20;
        outline: none;
        transition: border 0.17s;
    }
    .form-row input:focus, .form-row select:focus {
        border-color: #4ca548;
    }
    .submit-btn {
        width: 100%;
        padding: 17px 0;
        background: linear-gradient(90deg, #4ca548, #347a2a 70%);
        color: #fff;
        border: none;
        font-size: 1.18rem;
        font-weight: bold;
        border-radius: 9px;
        cursor: pointer;
        margin-top: 9px;
        transition: background 0.19s;
    }
    .submit-btn:hover {
        background: linear-gradient(90deg, #347a2a, #4ca548 70%);
    }
    .loading { text-align: center; color: #5a715a; font-style: italic; }
    .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .recommendation-result {
        background: #f8fbf8;
        border: 2px solid #4ca548;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
    }
    .crop-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #193718;
        margin-bottom: 10px;
    }
    .confidence-score {
        background: #4ca548;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 15px;
    }
    </style>
</head>
<body>
    <div class="crop-header">
    <button class="back-btn" onclick="window.location.href='/dashboard/'">&#8592;</button>
        <div class="crop-header-title">Dashboard</div>
    </div>
    <div class="crop-section-title">Crop Recommendation</div>
    <div class="crop-section-subtitle">Get smart crop suggestions based on your land</div>
    <div class="form-card">
        <div class="form-title">Farm Details</div>
        <form id="recommendation-form">
            <div class="form-row" style="flex-direction:column;">
                <label for="location" style="font-weight:500;">Location</label>
                <input type="text" id="location" placeholder="Enter your location">
            </div>
            <div class="form-row">
                <div>
                    <label for="nitrogen" style="font-weight:500;">Nitrogen (ppm)</label>
                    <input type="number" id="nitrogen" placeholder="e.g., 100" required>
                </div>
                <div>
                    <label for="phosphorus" style="font-weight:500;">Phosphorus (ppm)</label>
                    <input type="number" id="phosphorus" placeholder="e.g., 50" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="potassium" style="font-weight:500;">Potassium (ppm)</label>
                    <input type="number" id="potassium" placeholder="e.g., 200" required>
                </div>
                <div>
                    <label for="temperature" style="font-weight:500;">Temperature (Â°C)</label>
                    <input type="number" id="temperature" placeholder="e.g., 25">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="humidity" style="font-weight:500;">Humidity (%)</label>
                    <input type="number" id="humidity" placeholder="e.g., 70">
                </div>
                <div>
                    <label for="ph" style="font-weight:500;">pH Level</label>
                    <input type="number" step="0.1" id="ph" placeholder="e.g., 6.5" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="rainfall" style="font-weight:500;">Rainfall (mm)</label>
                    <input type="number" id="rainfall" placeholder="e.g., 1000">
                </div>
                <div>
                    <label for="land-size" style="font-weight:500;">Land Size (Acres)</label>
                    <input type="number" id="land-size" placeholder="e.g., 5">
                </div>
            </div>
            <button class="submit-btn" type="submit">Get Recommendation</button>
        </form>
    </div>
    
    <div id="recommendation-results" class="form-card" style="display: none;">
        <div class="form-title">Recommendation Results</div>
        <div id="loading" class="loading" style="display: none;">Getting recommendation...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="recommendation-details">
            <div id="rec-summary" style="margin-bottom:12px;"></div>
            <div id="rec-yield" style="font-weight:600;margin-bottom:8px;"></div>
            <div id="rec-price" style="margin-bottom:8px;"></div>
            <div id="rec-best-month" style="margin-bottom:12px; font-weight:700; color:#1b5e20;"></div>
            <canvas id="price-forecast-chart" width="600" height="250" style="background:#fff;padding:12px;border-radius:8px;border:1px solid #e7f3e7;"></canvas>
        </div>
    </div>

    <script src="{% static 'assets/js/api.js' %}"></script>
    <script src="{% static 'assets/js/i18n.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('recommendation-form');
            form.addEventListener('submit', handleRecommendation);
        });

        async function handleRecommendation(e) {
            e.preventDefault();
            
            const resultsDiv = document.getElementById('recommendation-results');
            const loading = document.getElementById('loading');
                const errorEl = document.getElementById('error');
            const details = document.getElementById('recommendation-details');
            
            // Show loading state
            resultsDiv.style.display = 'block';
            loading.style.display = 'block';
            errorEl.style.display = 'none';
            // keep the details container intact (don't clear its inner HTML or we lose the result nodes)
            details.style.display = 'block';
            
            // Collect and validate required fields (N, P, K, pH)
            const n = parseFloat(document.getElementById('nitrogen').value);
            const p = parseFloat(document.getElementById('phosphorus').value);
            const k = parseFloat(document.getElementById('potassium').value);
            const phVal = parseFloat(document.getElementById('ph').value);

            if (isNaN(n) || isNaN(p) || isNaN(k) || isNaN(phVal)) {
                loading.style.display = 'none';
                resultsDiv.style.display = 'block';
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'Please fill the required fields: Nitrogen, Phosphorus, Potassium and pH.';
                return;
            }

            // Optional fields are accepted but not required by the model
            const temperature = parseFloat(document.getElementById('temperature').value) || 0;
            const humidity = parseFloat(document.getElementById('humidity').value) || 0;
            const rainfall = parseFloat(document.getElementById('rainfall').value) || 0;

            // Send only features the model expects: [N, P, K, pH]
            const features = [n, p, k, phVal];
            
            try {
                // include farmer_id if available
                const farmerId = localStorage.getItem('farmer_id');
                const payload = { features: features };
                if (farmerId) payload.farmer_id = parseInt(farmerId);

                const result = await window.api.recommendCrop(payload);
                
                // Hide loading, show results
                loading.style.display = 'none';
                const summary = document.getElementById('rec-summary');
                const yieldEl = document.getElementById('rec-yield');
                const priceEl = document.getElementById('rec-price');
                const bestMonthEl = document.getElementById('rec-best-month');

                summary.innerHTML = `<div class="recommendation-result"><div class="crop-name">${result.recommended_crop}</div></div>`;
                yieldEl.textContent = `Expected yield: ${result.expected_yield}`;
                priceEl.textContent = `Predicted price: ${result.predicted_price}`;
                bestMonthEl.textContent = `Best selling month: ${result.best_selling_month}`;

                // Draw forecast chart
                const chartCanvas = document.getElementById('price-forecast-chart');
                const ctx = chartCanvas.getContext('2d');
                // Clean previous chart (if any)
                if (window._priceChart) { window._priceChart.destroy(); }
                const labels = ['M1','M2','M3','M4','M5','M6'];
                const dataPoints = [
                    result.forecast.month_1,
                    result.forecast.month_2,
                    result.forecast.month_3,
                    result.forecast.month_4,
                    result.forecast.month_5,
                    result.forecast.month_6,
                ];
                // Load Chart.js dynamically if not present
                function loadChartAndRender(){
                    if (typeof Chart === 'undefined') {
                        const s = document.createElement('script');
                        s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                        s.onload = renderChart;
                        document.head.appendChild(s);
                    } else renderChart();
                }

                function renderChart(){
                    window._priceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Predicted price (â¹)',
                                data: dataPoints,
                                borderColor: '#2e7d32',
                                backgroundColor: 'rgba(46,125,50,0.1)',
                                tension: 0.3,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: false }
                            }
                        }
                    });
                }

                loadChartAndRender();
            } catch (err) {
                console.error('Error getting recommendation:', err);
                loading.style.display = 'none';
                errorEl.style.display = 'block';
                // Show server / network error details if available to aid debugging
                const msg = (err && err.message) ? err.message : String(err);
                errorEl.textContent = 'Failed to get recommendation. ' + msg;
            }
        }
    </script>
</body>
</html>
